services:
  # =========================================
  # Brain Core — Always-on AI orchestrator
  # =========================================
  brain_core:
    image: jetrover/brain:latest
    container_name: rover_brain_core
    runtime: nvidia
    restart: unless-stopped

    # OOM protection — medium priority
    mem_limit: 2200m
    oom_score_adj: -500

    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
      - ROS_DOMAIN_ID=42
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - FASTRTPS_DEFAULT_PROFILES_FILE=/opt/rover/config/fastdds.xml
      - CUDA_VISIBLE_DEVICES=0
      - ORT_TENSORRT_ENGINE_CACHE_ENABLE=1

    volumes:
      # Database persistence
      - ./db:/opt/rover/db
      # Model files (read-only)
      - ./models:/opt/rover/models:ro
      # Temporary files (shared with host)
      - /tmp:/tmp
      # ROS2 workspace source (development mode)
      - ./src/ai:/opt/rover/ws/src:ro

    network_mode: host

    # Healthcheck
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8080/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

    # OOM score adjustment (via docker run --oom-score-adj)
    # -500: protected from OOM killer, but not absolute
    sysctls:
      - net.core.rmem_max=2147483647
      - net.core.wmem_max=2147483647

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

  # =========================================
  # LLM Runner — Sacrificial service
  # =========================================
  llm_service:
    image: jetrover/brain:latest
    container_name: rover_llm
    runtime: nvidia
    restart: on-failure:3

    # OOM score: 800 (highest = killed first)
    mem_limit: 1800m
    oom_score_adj: 800

    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - ROS_DOMAIN_ID=42
      - LLM_MODEL=/opt/rover/models/llm/qwen2.5-3b-instruct-q4_k_m.gguf
      - LLAMA_SERVER_PORT=11434

    volumes:
      - ./models/llm:/opt/rover/models/llm:ro
      - /tmp:/tmp

    network_mode: host

    command: >
      llama-server --model /opt/rover/models/llm/qwen2.5-3b-instruct-q4_k_m.gguf --port 11434 --ctx-size 2048 --n-gpu-layers 99 --threads 4 --parallel 2

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:11434/health" ]
      interval: 15s
      timeout: 5s
      retries: 2

    depends_on:
      - brain_core

    deploy:
      resources:
        limits:
          memory: 1800m
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

  # =========================================
  # VLM Runner — Sacrificial service
  # =========================================
  vlm_service:
    image: jetrover/brain:latest
    container_name: rover_vlm
    runtime: nvidia
    restart: on-failure:3

    # OOM score: 700 (killed second)
    mem_limit: 2500m
    oom_score_adj: 700

    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - ROS_DOMAIN_ID=42
      - VLM_MODEL=/opt/rover/models/vlm/moondream2-text-model-f16.gguf
      - VLM_MMPROJ=/opt/rover/models/vlm/moondream2-mmproj-f16.gguf

    volumes:
      - ./models/vlm:/opt/rover/models/vlm:ro
      - /tmp:/tmp

    network_mode: host

    command: >
      llama-server --model /opt/rover/models/vlm/moondream2-text-model-f16.gguf --mmproj /opt/rover/models/vlm/moondream2-mmproj-f16.gguf --port 8081 --ctx-size 2048 --n-gpu-layers 99

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081/health" ]
      interval: 15s
      timeout: 5s
      retries: 2

    depends_on:
      - brain_core

    deploy:
      resources:
        limits:
          memory: 2500m
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

  # =========================================
  # Host Bridge — Absolute protection
  # =========================================
  host_bridge:
    image: jetrover/brain:latest
    container_name: rover_host_bridge
    restart: always

    # OOM score: -1000 (never killed)
    mem_limit: 512m
    oom_score_adj: -1000

    environment:
      - ROS_DOMAIN_ID=42

    volumes:
      - /tmp:/tmp

    network_mode: host
    privileged: true

    command: >
      ros2 run rover_common heartbeat_node

    healthcheck:
      test: [ "CMD", "ros2", "topic", "echo", "/heartbeat", "--once" ]
      interval: 10s
      timeout: 3s
      retries: 5
