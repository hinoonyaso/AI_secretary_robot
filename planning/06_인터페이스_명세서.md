# 인터페이스 명세서

## JetRover AI 아키텍처

**최종 통합 기술 설계 문서**  
버전 3.0 | 2026년 2월

---

## 하드웨어 인터페이스

### Jetson ↔ STM32 통신

| 속성 | 값 |
|------|-----|
| 인터페이스 | USB CDC ACM |
| 속도 | Full Speed 12 Mbps |
| 프로토콜 | 커스텀 바이너리 프로토콜 |
| 케이블 | USB 2.0 Micro-B 또는 USB-C |
| 전원 | Jetson에서 5V/500mA 공급 |

### STM32 ↔ DC 모터 인터페이스

| 속성 | 값 |
|------|-----|
| 제어 신호 | PWM (50Hz~100Hz) |
| 피드백 | ABZ 엔코더 (1024 PPR) |
| 구동 전압 | 12V DC |
| 모터 수 | 4채널 (Mecanum 4휠) |
| PID 주파수 | 100Hz |

### STM32 ↔ 버스 서보 인터페이스

| 속성 | 값 |
|------|-----|
| 프로토콜 | Hiwonder TTL 반이중 UART |
| 통신 속도 | 115,200 ~ 500,000 bps |
| 토폴로지 | 데이지체인 (9개 서보) |
| 서보 ID | 1-6: arm, 7: gripper, 8-9: pan_tilt |
| 위치 범위 | 0-1000 (0°~240°) |
| 중앙값 | 500 (120°) |

### LiDAR 인터페이스

| 속성 | 값 |
|------|-----|
| 모델 | RPLIDAR A1 |
| 인터페이스 | USB 2.0 |
| 스캔 속도 | 5.5Hz (기본), 최대 10Hz |
| 각도 범위 | 360° |
| 거리 범위 | 0.15m ~ 12m |
| 해상도 | ≤ 1% 거리 오차 |

### RGB-D 칩메라 인터페이스

| 속성 | 값 |
|------|-----|
| 모델 | DaBai DCW |
| RGB 해상도 | 640x480 @ 30fps |
| 깊이 해상도 | 640x480 @ 30fps |
| 인터페이스 | USB 3.0 |
| 깊이 범위 | 0.3m ~ 3m |
| FOV | H: 69°, V: 42° |

### 마이크 어레이 인터페이스

| 속성 | 값 |
|------|-----|
| 구성 | 6마이크 선형 어레이 |
| 인터페이스 | USB Audio (ALSA) |
| 샘플링 레이트 | 16kHz |
| 비트 깊이 | 16-bit |
| 채널 | 6채널 |

---

## 소프트웨어 API 인터페이스

### LLM 서버 (llama.cpp HTTP API)

#### POST /completion
텍스트 생성 요청

**Request:**
```json
{
  "prompt": "사용자: 안녕하세요\nAI:",
  "n_predict": 128,
  "temperature": 0.3,
  "stream": true,
  "stop": ["\n사용자:", "</s>"]
}
```

**Response:**
```json
{
  "content": "안녕하세요! 무엇을 도와드릴까요?",
  "generation_settings": {
    "temperature": 0.3,
    "n_predict": 128
  },
  "timings": {
    "predicted_per_token_ms": 15.2
  }
}
```

#### POST /tokenize
토큰화 요청

**Request:**
```json
{
  "content": "안녕하세요"
}
```

**Response:**
```json
{
  "tokens": [101, 12345, 67890]
}
```

### TTS 서버 (sherpa-onnx)

#### POST /tts
텍스트 → 음성 변환

**Request:**
```json
{
  "text": "안녕하세요",
  "sid": 0,
  "speed": 1.0
}
```

**Response:**
```json
{
  "sample_rate": 22050,
  "audio": "<base64_encoded_pcm>"
}
```

### STT 서버 (sherpa-onnx)

#### POST /recognize (Streaming)
음성 → 텍스트 변환 (WebSocket 또는 HTTP 스트리밍)

**Request (Chunk):**
```json
{
  "audio": "<base64_encoded_pcm_chunk>",
  "is_final": false
}
```

**Response:**
```json
{
  "text": "안녕하세요",
  "is_final": true,
  "confidence": 0.95
}
```

---

## ROS2 액션 인터페이스

### MoveIt2 FollowJointTrajectory

**Action Name:** `/arm_controller/follow_joint_trajectory`

**Goal:**
```
trajectory_msgs/JointTrajectory trajectory
  string[] joint_names
  JointTrajectoryPoint[] points
    float64[] positions
    float64[] velocities
    float64[] accelerations
    duration time_from_start
```

**Result:**
```
int32 error_code
string error_string
```

**Feedback:**
```
JointTrajectoryPoint desired
JointTrajectoryPoint actual
JointTrajectoryPoint error
```

### Nav2 NavigateToPose

**Action Name:** `/navigate_to_pose`

**Goal:**
```
geometry_msgs/PoseStamped pose
  Header header
  Pose pose
    Point position
    Quaternion orientation
```

**Result:**
```
int16 navigation_time
int16 number_of_recoveries
float32 distance_remaining
int16 error_code
```

---

## 토픽 인터페이스 요약

### 입력 토픽 (구독)

| 토픽명 | 타입 | 설명 |
|--------|------|------|
| `/cmd_vel` | geometry_msgs/Twist | 속도 명령 |
| `/goal_pose` | geometry_msgs/PoseStamped | 목표 위치 |
| `/pan_tilt_cmd` | std_msgs/Float64MultiArray | 팬틸트 각도 |
| `/tts_request` | std_msgs/String | TTS 요청 텍스트 |

### 출력 토픽 (발행)

| 토픽명 | 타입 | 설명 |
|--------|------|------|
| `/odom` | nav_msgs/Odometry | 휠 오도메트리 |
| `/scan` | sensor_msgs/LaserScan | LiDAR 스캔 |
| `/joint_states` | sensor_msgs/JointState | 관절 상태 |
| `/tf` | tf2_msgs/TFMessage | 좌표 변환 |
| `/yolo/detections` | vision_msgs/Detection2DArray | 객체 감지 |
| `/stt_result` | std_msgs/String | STT 결과 |
| `/intent` | std_msgs/String | 분류된 의도 |

---

## 서비스 인터페이스

### LLM 서비스

| 서비스명 | 타입 | 설명 |
|----------|------|------|
| `/llm/generate` | llm_msgs/Generate | 텍스트 생성 |
| `/llm/clear_context` | std_srvs/Empty | 컨텍스트 초기화 |

### 로봇암 서비스

| 서비스명 | 타입 | 설명 |
|----------|------|------|
| `/arm/get_position` | arm_msgs/GetPosition | 현재 위치 조회 |
| `/arm/set_position` | arm_msgs/SetPosition | 위치 설정 |
| `/gripper/set_position` | gripper_msgs/SetPosition | 그리퍼 설정 |

---

*JetRover AI Architecture v3.0 | Jetson Orin Nano 8GB + ROS2 Humble + 6DOF Mecanum*
