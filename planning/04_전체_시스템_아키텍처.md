# 전체 시스템 아키텍처

## JetRover AI 아키텍처

**최종 통합 기술 설계 문서**  
버전 3.0 | 2026년 2월

---

## 아키텍처 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              JetRover AI System                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │   음성 처리   │  │   비전 처리   │  │   자연어    │  │   로봇 제어   │    │
│  │   Pipeline   │  │   Pipeline   │  │   처리      │  │   Pipeline   │    │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │
│         │                 │                 │                 │            │
│  ┌──────▼─────────────────▼─────────────────▼─────────────────▼───────┐    │
│  │                      Intent Router (KoSimCSE)                      │    │
│  └──────┬────────────────────────────────────────────────────────────┘    │
│         │                                                                  │
│  ┌──────▼────────────────────────────────────────────────────────────┐    │
│  │                      ROS2 Humble (CycloneDDS)                      │    │
│  └──────┬────────────────────────────────────────────────────────────┘    │
│         │                                                                  │
│  ┌──────▼──────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐   │
│  │   SLAM/Nav2    │  │   MoveIt2    │  │ ros2_control │  │ 센서 드라이버│   │
│  └──────┬──────────┘  └──────┬───────┘  └──────┬───────┘  └────┬─────┘   │
│         │                    │                 │               │          │
│  ┌──────▼────────────────────▼─────────────────▼───────────────▼──────┐  │
│  │                         Hardware Interface                          │  │
│  │  (STM32F407 → Mecanum/서보/LiDAR/칩메라/마이크)                      │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 레이어 구조

### Layer 1: AI 처리 레이어
| 컴포넌트 | 기술 스택 | 역할 |
|----------|-----------|------|
| 음성 처리 | Porcupine + sherpa-onnx | 웨이크워드, VAD, STT, TTS |
| 비전 처리 | YOLO11n TRT + moondream2 | 객체 감지, 장면 분석 |
| 자연어 처리 | Qwen2.5-1.5B GGUF | 대화, 명령 해석 |
| 의도 분류 | KoSimCSE ONNX | 사용자 의도 분류 |

### Layer 2: 미들웨어 레이어
| 컴포넌트 | 기술 스택 | 역할 |
|----------|-----------|------|
| ROS2 코어 | ROS2 Humble + CycloneDDS | 노드 통신, 데이터 흐름 |
| Intent Router | Python + ONNX Runtime | 의도 → 액션 라우팅 |
| 상태 관리 | rclpy + 파라미터 서버 | 시스템 상태 공유 |

### Layer 3: 로봇 제어 레이어
| 컴포넌트 | 기술 스택 | 역할 |
|----------|-----------|------|
| SLAM/Localization | slam_toolbox | 맵핑, 위치 추정 |
| 네비게이션 | Nav2 (A* + DWB) | 경로 계획, 장애물 회피 |
| 팔 제어 | MoveIt2 + trac-ik | IK, 경로 계획, 실행 |
| 저수준 제어 | ros2_control | 관절 상태, 하드웨어 인터페이스 |

### Layer 4: 하드웨어 인터페이스 레이어
| 컴포넌트 | 기술 스택 | 역할 |
|----------|-----------|------|
| STM32 브리지 | USB CDC | 모터/서보 명령 중계 |
| 센서 드라이버 | rplidar_ros, dabai_dcw | LiDAR, RGB-D 데이터 수집 |
| 하드웨어 추상 | ros2_control | 하드웨어 독립적 제어 |

---

## 통신 토폴로지

```
Jetson Orin Nano ─── USB ─── STM32F407 ┬── PWM+ENC ── MC520×4 (Mecanum)
                                        └── TTL 반이중 ── HTD-35H3×6 + HTS-21H×1 + HTS-20H1×2
```

### 통신 인터페이스 상세

| 구간 | 프로토콜 | 속도 | 비고 |
|------|----------|------|------|
| Jetson ↔ STM32 | USB CDC | Full Speed 12Mbps | 단일 케이블 (모터+서보 통합) |
| STM32 ↔ DC모터 | PWM + 엔코더 ABZ | 100Hz 제어 | 4채널 독립 PID |
| STM32 ↔ 버스서보 | 반이중 UART TTL | 115200~500000bps | 9개 데이지체인, ~50Hz 안정 |
| STM32 → Jetson | odom + IMU 토픽 | 50Hz | robot_localization EKF 입력 |

### 버스 서보 제어 타이밍

| 버스 속도 | 서보 1개 왕복 | 9개 풀 루프 | 안정 제어 Hz |
|-----------|---------------|-------------|--------------|
| 115,200 bps (기본) | ~2ms | ~18ms | ~55Hz (여유 있음) |
| 500,000 bps (고속) | ~0.7ms | ~6.3ms | ~100Hz (최대) |
| **권장 운용 (안전 여유 포함)** | — | — | **50Hz (ros2_control update_rate)** |

---

## 데이터 흐름 다이어그램

### 음성 명령 처리 흐름
```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  마이크   │───>│ 웨이크워드 │───>│   VAD    │───>│   STT    │───>│ 의도분류  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └────┬─────┘
                                                                     │
                    ┌────────────────────────────────────────────────┘
                    ▼
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│   TTS    │<───│   LLM    │<───│  액션    │<───┘
└────┬─────┘    └──────────┘    │ 실행기   │
     │                          └──────────┘
     ▼
┌──────────┐
│  스피커   │
└──────────┘
```

### 자율 이동 흐름
```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  LiDAR   │───>│   SLAM   │───>│   EKF    │───>│   Nav2   │
└──────────┘    └──────────┘    └──────────┘    └────┬─────┘
                                                     │
┌──────────┐    ┌──────────┐    ┌──────────┐        │
│  모터    │<───│  STM32   │<───│ ros2_ctrl│<───────┘
└──────────┘    └──────────┘    └──────────┘
```

### 로봇암 조작 흐름
```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  명령    │───>│ MoveIt2  │───>│ trac-ik  │───>│  OMPL    │───>│  경로    │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └────┬─────┘
                                                                     │
┌──────────┐    ┌──────────┐    ┌──────────┐                        │
│  서보    │<───│  STM32   │<───│hiwonder_ │<───────────────────────┘
└──────────┘    └──────────┘    │ bridge   │
                                └──────────┘
```

---

## 핵심 결정 사항

| 결정 항목 | 선택 | 근거 |
|-----------|------|------|
| Brain 런타임 | systemd native | GPU/SHM 직접 접근. Level3 강등 시 재시작 1~3s 빠름 |
| 클라우드 연동 | Offline-First (선택적 가속) | 네트워크 단절 시 완전 동작 보장 |
| DDS 구현 | CycloneDDS | Jetson에서 성능 우수, /dev/shm 공유 메모리 지원 |
| 팬틸트 | MoveIt 제외, 독립 토픽 | 실시간 칩메라 시선 제어에 action 인터페이스 부적합 |

---

*JetRover AI Architecture v3.0 | Jetson Orin Nano 8GB + ROS2 Humble + 6DOF Mecanum*
