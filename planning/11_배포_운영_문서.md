# 배포/운영 문서

## JetRover AI 아키텍처

**최종 통합 기술 설계 문서**  
버전 3.0 | 2026년 2월

---

## 시스템 요구사항

### 하드웨어

| 항목 | 사양 | 비고 |
|------|------|------|
| 메인 컴퓨터 | Jetson Orin Nano 8GB | |
| 저장장치 | 64GB 이상 microSD 또는 NVMe SSD | |
| 전원 | 5V 4A 이상 | Jetson 전용 |
| 서보 전원 | 11.1V LiPo 배터리 | HTD-35H3용 |
| 모터 전원 | 12V DC | MC520용 |

### 소프트웨어

| 항목 | 버전 | 비고 |
|------|------|------|
| JetPack | 6.x | |
| Ubuntu | 22.04 LTS | |
| ROS2 | Humble Hawksbill | |
| CUDA | 12.6 | |
| cuDNN | 9.x | |
| TensorRT | 8.6+ | |

---

## 설치 절차

### 1. JetPack 설치

```bash
# 시스템 업데이트
sudo apt update && sudo apt upgrade -y

# JetPack 구성 요소 설치
sudo apt install nvidia-jetpack
```

### 2. ROS2 Humble 설치

```bash
# 로케일 설정
sudo apt update && sudo apt install locales
sudo locale-gen en_US en_US.UTF-8
sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
export LANG=en_US.UTF-8

# ROS2 저장소 추가
sudo apt install software-properties-common
sudo add-apt-repository universe
sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null

# ROS2 설치
sudo apt update
sudo apt install ros-humble-desktop ros-dev-tools

# 환경 설정
echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc
source ~/.bashrc
```

### 3. 필수 ROS2 패키지 설치

```bash
sudo apt install \
    ros-humble-slam-toolbox \
    ros-humble-nav2-bringup \
    ros-humble-moveit \
    ros-humble-trac-ik \
    ros-humble-ros2-control \
    ros-humble-ros2-controllers \
    ros-humble-joint-state-publisher \
    ros-humble-robot-state-publisher \
    ros-humble-robot-localization
```

### 4. Python 패키지 설치

```bash
# 가상환경 생성 (권장)
python3 -m venv ~/jetrover_env
source ~/jetrover_env/bin/activate

# 핵심 패키지
pip install sherpa-onnx onnxruntime-gpu rapidocr-onnxruntime

# onnxruntime 중복 방지 (필수!)
pip uninstall onnxruntime -y
pip install onnxruntime-gpu  # CUDA EP + CPU EP 통합
```

### 5. llama.cpp 빌드 (GPU 지원)

```bash
git clone https://github.com/ggerganov/llama.cpp
cd llama.cpp
mkdir build && cd build

cmake .. \
    -DGGML_CUDA=ON \
    -DCMAKE_CUDA_ARCHITECTURES=87 \
    -DLLAMA_CUDA_F16=ON

make -j$(nproc)
sudo make install
```

### 6. AI 모델 다운로드

```bash
mkdir -p ~/models
cd ~/models

# Qwen2.5-1.5B GGUF
wget https://huggingface.co/Qwen/Qwen2.5-1.5B-Instruct-GGUF/resolve/main/qwen2.5-1.5b-instruct-q4_k_m.gguf

# moondream2 GGUF
wget https://huggingface.co/vikhyatk/moondream2/resolve/main/moondream2-text-model-q4.gguf
wget https://huggingface.co/vikhyatk/moondream2/resolve/main/moondream2-mmproj-f16.gguf

# moonshine-tiny-ko (sherpa-onnx)
wget https://github.com/k2-fsa/sherpa-onnx/releases/download/asr-models/moonshine-tiny-ko.tar.gz
tar xzf moonshine-tiny-ko.tar.gz

# KoSimCSE ONNX
wget https://huggingface.co/sentence-transformers/roberta-base-nli-stsb-mean-tokens/resolve/main/model.onnx

# Piper TTS 한국어
wget https://huggingface.co/rhasspy/piper-voices/resolve/main/ko/ko_KO/.../ko_KO-medium.onnx
```

### 7. 전력 설정

```bash
# 15W MAXN 모드 고정
sudo nvpmodel -m 0

# 클럭 최대화
sudo jetson_clocks

# 부팅 시 자동 적용
sudo systemctl enable nvpmodel
sudo systemctl enable jetson_clocks
```

---

## systemd 서비스 구성

### 서비스 그룹 구조

```
그룹 1: 하드웨어 인터페이스 (최우선 시작)
├── ros_robot_controller.service
├── rplidar_ros.service
└── dabai_dcw_driver.service

그룹 2: 상태 추정
├── robot_state_publisher.service
├── joint_state_broadcaster.service
└── ekf_filter_node.service

그룹 3: SLAM & 네비게이션
├── slam_toolbox.service
└── nav2.service

그룹 4: 팔 제어
├── controller_manager.service
├── arm_trajectory_controller.service
├── hiwonder_bridge.service
└── pan_tilt_controller.service

그룹 5: AI 스택 (마지막 시작)
├── porcupine_node.service
├── sherpa_onnx_node.service
├── yolo11n_trt_node.service
├── intent_router.service
├── llama_cpp_server.service
└── heartbeat_monitor.service
```

### 서비스 파일 예시

#### ros_robot_controller.service

```ini
[Unit]
Description=Hiwonder Robot Controller
After=network.target
Before=ros2_nodes.target

[Service]
Type=simple
User=jetson
Environment="ROS_DOMAIN_ID=0"
Environment="ROS_LOCALHOST_ONLY=0"
Environment="RMW_IMPLEMENTATION=rmw_cyclonedds_cpp"
ExecStart=/opt/ros/humble/bin/ros2 run ros_robot_controller robot_controller
Restart=always
RestartSec=1

[Install]
WantedBy=multi-user.target
```

#### heartbeat_monitor.service

```ini
[Unit]
Description=JetRover Heartbeat Monitor
After=jetrover_ai.target

[Service]
Type=simple
User=jetson
ExecStart=/home/jetson/jetrover_ws/src/heartbeat_monitor/heartbeat_monitor.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

### 서비스 활성화

```bash
# 모든 서비스 등록
sudo systemctl enable ros_robot_controller
sudo systemctl enable rplidar_ros
sudo systemctl enable dabai_dcw_driver
sudo systemctl enable robot_state_publisher
sudo systemctl enable joint_state_broadcaster
sudo systemctl enable ekf_filter_node
sudo systemctl enable slam_toolbox
sudo systemctl enable nav2
sudo systemctl enable controller_manager
sudo systemctl enable arm_trajectory_controller
sudo systemctl enable hiwonder_bridge
sudo systemctl enable pan_tilt_controller
sudo systemctl enable porcupine_node
sudo systemctl enable sherpa_onnx_node
sudo systemctl enable yolo11n_trt_node
sudo systemctl enable intent_router
sudo systemctl enable llama_cpp_server
sudo systemctl enable heartbeat_monitor

# 서비스 시작
sudo systemctl start jetrover_bringup
```

---

## 운용 정책

### 인터락 및 안전 정책

| 정책 | 트리거 | 조치 |
|------|--------|------|
| LLM 실행 전 정지 | 음성 명령 수신 (속도 > 0.05m/s) | Nav2 velocity smoother 0 → 완전 정지 확인 → LLM 시작 |
| VLM 실행 조건 | "장면 분석" 인텐트 감지 | YOLO 언로드 → LLM KV 캐시 해제 → VLM 적재 → 완료 후 YOLO 재적재 |
| 맵핑 중 AI 제한 | online_sync 모드 활성 | VLM 비활성, LLM MAX_HISTORY 2턴, TTS 우선 처리 |
| A* 재계획 중 LLM 금지 | planner_server 액션 실행 중 | LLM 요청 큐잉 (최대 2.0s), DWB는 기존 경로로 계속 주행 |
| 열 제한 (5s 지속) | 온도 ≥ 70°C 5초 연속 or RAM < 2.5GB | Level1: VLM 비활성, Level2: LLM 비활성, Level3: YOLO만 유지 |
| 긴급 팔 정지 | "정지" 인텐트 or 충돌 감지 | STM32 Emergency Stop 패킷 즉시 전송 → MoveIt 목표 취소 |

### 음성 명령 수신 시퀀스

```
1. Porcupine 웨이크워드 감지
   └──> 마이크 핸들 STT로 전환
   │
2. Nav2 velocity smoother 속도 0 명령 발행
   │
3. odom 속도 < 0.05m/s 확인 (완전 정지)
   │
4. llama.cpp 추론 시작 (nice +10, GPU -ngl 99)
   │
5. 응답 스트리밍 → Piper TTS 첫 문장부터 재생
   │
6. 명령 실행 (Nav2 goal or MoveIt plan)
   │
7. Porcupine 재활성
```

### VLM 호출 시퀀스

```
1. "장면 분석" 인텐트 감지
   │
2. TTS "분석 중입니다..." 브리징 출력
   │
3. YOLO TRT 엔진 unload() → ~400MB 회수
   │
4. LLM KV 캐시 초기화
   │
5. moondream2 GGUF 로드 → 이미지 인코딩 → 추론
   │
6. 결과 TTS 출력
   │
7. YOLO TRT 엔진 재적재 (~200ms)
```

---

## 모니터링 및 로깅

### 전력 모니터링

```bash
# 전력 모니터링 (13W 초과 시 경보)
tegrastats --interval 500 | grep VDD_CPU_GPU_CV

# 또는 전체 정보
tegrastats --interval 1000
```

### 메모리 모니터링

```bash
# 메모리 사용량
free -h

# 사용 가능한 메모리
cat /proc/meminfo | grep MemAvailable

# 프로세스별 메모리
ps aux --sort=-%mem | head -20
```

### 온도 모니터링

```bash
# SoC 온도
cat /sys/class/thermal/thermal_zone*/temp

# 또는
tegrastats | grep temp
```

### ROS2 토픽 모니터링

```bash
# 토픽 주파수
ros2 topic hz /scan /joint_states /odom

# 토픽 내용 확인
ros2 topic echo /intent

# 노드 상태
ros2 node list
ros2 service list
```

### 로깅 설정

```yaml
# ros2 logging
ros2 run rqt_console rqt_console

# 파일 로깅
ros2 bag record -a -o /home/jetson/logs/$(date +%Y%m%d_%H%M%S)
```

---

## 백업 및 복구

### 설정 파일 백업

```bash
# 백업 디렉토리 생성
mkdir -p ~/backup/$(date +%Y%m%d)

# ROS2 설정 백업
cp -r ~/.ros ~/backup/$(date +%Y%m%d)/
cp -r ~/ros2_ws/src ~/backup/$(date +%Y%m%d)/

# AI 모델 백업
cp -r ~/models ~/backup/$(date +%Y%m%d)/

# 시스템 설정 백업
sudo cp -r /etc/systemd/system/ros-* ~/backup/$(date +%Y%m%d)/

# 환경 설정 백업
cp ~/.bashrc ~/backup/$(date +%Y%m%d)/
```

### 복구 절차

| 상황 | 복구 방법 |
|------|-----------|
| 시스템 부팅 실패 | 복구 모드 진입 → 파일 시스템 검사 |
| ROS2 노드 충돌 | heartbeat_monitor 자동 재시작 확인 |
| AI 모델 오류 | 캐시 삭제 후 재적재: `rm -rf ~/.cache/sherpa-onnx` |
| 심각한 오류 | SD 카드 이미지 복원 |

### SD 카드 이미지 백업/복원

```bash
# 백업 (호스트 PC에서)
sudo dd if=/dev/sdX of=jetrover_backup.img bs=4M status=progress

# 복원 (호스트 PC에서)
sudo dd if=jetrover_backup.img of=/dev/sdX bs=4M status=progress
```

---

## 핵심 결정 사항 요약

| 결정 항목 | 선택 | 근거 |
|-----------|------|------|
| Brain 런타임 | systemd native | GPU/SHM 직접 접근. Level3 강등 시 재시작 1~3s 빠름 |
| 클라우드 연동 | Offline-First (선택적 가속) | 네트워크 단절 시 완전 동작 보장 |
| STT 정밀도 | sherpa-onnx GPU (moonshine) | BF16 frontend CPU에서 FP32 강등 → 정확도 저하 확인 |
| YOLO 정밀도 | FP16 TRT (INT8 금지) | Orin Nano에서 INT8 실익 없음 |
| PyTorch 제거 | 완전 제거 가능 | sherpa-onnx + llama.cpp + ORT 조합으로 torch import 0 |
| Nav2 메모리 | dynamic composition | 다중 프로세스 대비 메모리 70% 절감 |
| 팬틸트 | MoveIt 제외, 독립 토픽 | 실시간 칩메라 시선 제어에 action 인터페이스 부적합 |
| LLM 실행 조건 | 로봇 정지 후만 허용 | 이동 중 LLM → Jetson 16.5W → 15W TDP 초과 |
| 서보 제어 Hz | 50Hz (ros2_control) | TTL 버스 9개 데이지체인 레이턴시 현실적 한계 |
| MoveIt ↔ Hiwonder | hiwonder_bridge (신규 개발) | Hiwonder 토픽 기반 API ↔ 표준 ros2_control 간 변환 필요 |

---

*JetRover AI Architecture v3.0 | Jetson Orin Nano 8GB + ROS2 Humble + 6DOF Mecanum*
