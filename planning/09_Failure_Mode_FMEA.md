# Failure Mode 정의 (FMEA)

## JetRover AI 아키텍처

**최종 통합 기술 설계 문서**  
버전 3.0 | 2026년 2월

---

## FMEA 테이블

| ID | 구성요소 | 고장 모드 | 원인 | 영향 | 현재 통제 | RPN | 조치 |
|----|----------|-----------|------|------|-----------|-----|------|
| F-001 | Porcupine | 웨이크워드 미감지 | 마이크 노이즈, 잡음 환경 | 음성 명령 불가 | 6마이크 어레이, SNR 필터 | 6 | 잡음 환경 알림, 버튼 백업 |
| F-002 | STT | 인식 실패/오인식 | 발음 불분명, 방언 | 잘못된 명령 실행 | VAD 품질 게이트, 재시도 | 8 | "다시 말씀해 주세요" 요청 |
| F-003 | LLM | 응답 지연/타임아웃 | 복잡한 쿼리, 과부하 | 사용자 대기 | MAX_HISTORY 제한, 타임아웃 | 6 | 타임아웃 시 TTS 안내 |
| F-004 | YOLO | 객체 미감지 | 조명, occlusion | 충돌 위험 | 깊이 센서 융합, Nav2 코스트맵 | 9 | LiDAR 우선 회피 |
| F-005 | Nav2 | 경로 계획 실패 | 좁은 공간, 동적 장애물 | 이동 불가 | DWB 로컬 플래너, 복구 행동 | 7 | 사용자 알림, 수동 조작 |
| F-006 | MoveIt | IK 실패 | 특이 자세, 범위 초과 | 조작 불가 | trac-ik 다중 시도, 제한 설정 | 5 | 대체 자세 제안 |
| F-007 | STM32 | 통신 단절 | USB 케이블 분리 | 전체 제어 불가 | 하트비트 모니터링, 자동 재접속 | 10 | watchdog 재시작 |
| F-008 | LiDAR | 스캔 데이터 유실 | 모터 고장, 통신 오류 | SLAM 실패 | 데이터 타임스탬프 검증 | 8 | 오도메트리만으로 주행 |
| F-009 | 서보 | 위치 편차 | 부하 과다, 전압 저하 | 정밀도 저하 | 전류 모니터링, 위치 피드백 | 6 | 부하 경고, 속도 제한 |
| F-010 | Jetson | 과열 | 환경 온도, 연속 고부하 | 스로틀링, 성능 저하 | 온도 모니터링, 팬 제어 | 7 | 자동 성능 저하 모드 |
| F-011 | 메모리 | 부족 | 메모리 누수, 과다 적재 | OOM, 프로세스 종료 | 메모리 모니터링, 리소스 관리 | 9 | 비필수 프로세스 종료 |
| F-012 | 전원 | TDP 초과 | 이동+LLM 동시 실행 | 시스템 불안정 | 정책 기반 실행 제한 | 10 | 자동 LLM 중단 |

---

## 위험 등급 정의

| RPN 범위 | 등급 | 조치 수준 |
|----------|------|-----------|
| 1-3 | 낮음 | 모니터링 |
| 4-6 | 중간 | 주기적 점검 |
| 7-10 | 높음 | 즉시 조치 필요 |

---

## 고장 모드 상세 분석

### F-007: STM32 통신 단절 (RPN: 10)

**심각도**: 10 (시스템 전체 정지)  
**발생도**: 5 (드물지만 치명적)  
**탐지도**: 2 (즉시 탐지 가능)

**증상:**
- /joint_states 토픽 중단
- /odom 데이터 중단
- 모든 하드웨어 제어 불가

**복구 절차:**
1. 하트비트 타임아웃 감지 (500ms)
2. USB 재접속 시도
3. 실패 시 시스템 재시작
4. 복구 실패 시 안전 모드 진입

---

### F-012: 전원 TDP 초과 (RPN: 10)

**심각도**: 9 (성능 저하/불안정)  
**발생도**: 5 (정책 위반 시)  
**탐지도**: 2 (tegrastats 모니터링)

**증상:**
- Jetson 스로틀링
- AI 추론 지연
- 시스템 응답 지연

**방지 정책:**
| 조건 | 조치 |
|------|------|
| 속도 > 0.05m/s | LLM 실행 차단 |
| 맵핑 모드 | VLM 비활성, LLM 히스토리 2턴 제한 |
| 온도 ≥ 70°C | VLM → LLM → YOLO 순차 비활성 |

---

### F-004: YOLO 객체 미감지 (RPN: 9)

**심각도**: 9 (충돌 위험)  
**발생도**: 4 (조건 의존)  
**탐지도**: 3 (결과 검증 가능)

**대체 안전 장치:**
1. LiDAR 기반 장애물 감지 (Nav2 코스트맵)
2. 깊이 센서 기반 거리 측정
3. 비상 정지 버튼

**대응:**
- YOLO 신뢰도 < 0.5 시 LiDAR 우선
- 연속 미감지 시 사용자 알림

---

### F-011: 메모리 부족 (RPN: 9)

**심각도**: 8 (OOM 킬러 작동)  
**발생도**: 5 (과부하 시)  
**탐지도**: 2 (모니터링 가능)

**메모리 회수 우선순위:**
| 순위 | 프로세스 | 회수 메모리 |
|------|----------|-------------|
| 1 | moondream2 (VLM) | 1.75GB |
| 2 | LLM KV 캐시 | 0.5-1GB |
| 3 | YOLO (임시) | 400MB |
| 4 | slam_toolbox (mapping) | 100MB |

---

## 안전 정책

### 인터락 정책

| 정책 | 트리거 | 조치 |
|------|--------|------|
| LLM 실행 전 정지 | 음성 명령 수신 (속도 > 0.05m/s) | Nav2 velocity smoother 0 → 완전 정지 확인 → LLM 시작 |
| VLM 실행 조건 | "장면 분석" 인텐트 감지 | YOLO 언로드 → LLM KV 캐시 해제 → VLM 적재 → 완료 후 YOLO 재적재 |
| 맵핑 중 AI 제한 | online_sync 모드 활성 | VLM 비활성, LLM MAX_HISTORY 2턴, TTS 우선 처리 |
| A* 재계획 중 LLM 금지 | planner_server 액션 실행 중 | LLM 요청 큐잉 (최대 2.0s), DWB는 기존 경로로 계속 주행 |
| 열 제한 (5s 지속) | 온도 ≥ 70°C 5초 연속 or RAM < 2.5GB | Level1: VLM 비활성, Level2: LLM 비활성, Level3: YOLO만 유지 |
| 긴급 팔 정지 | "정지" 인텐트 or 충돌 감지 | STM32 Emergency Stop 패킷 즉시 전송 → MoveIt 목표 취소 |

### 응급 정지 시퀀스

```
1. Emergency Stop 트리거 감지
   ├──> STM32로 Emergency Stop 패킷 전송
   ├──> 모든 모터 정지 (PWM 0)
   ├──> 모든 서보 토크 유지 (현재 위치 고정)
   │
2. ROS2 레벨 정지
   ├──> MoveIt 목표 취소
   ├──> Nav2 goal 취소
   ├──> ros2_control 정지
   │
3. 상태 보고
   ├──> /diagnostics에 emergency_stop 발행
   └──> TTS로 "비상 정지되었습니다" 출력
   │
4. 복구 대기
   └──> 수동 복구 명령 대기
```

---

## 모니터링 및 알림

### 하트비트 모니터링

| 노드 | 주기 | 타임아웃 | 조치 |
|------|------|----------|------|
| ros_robot_controller | 50Hz | 100ms | 재시작 |
| slam_toolbox | 20Hz | 200ms | 경고 |
| nav2 | 20Hz | 200ms | 경고 |
| yolo11n_trt | 15Hz | 200ms | 재시작 |
| porcupine | 10Hz | 500ms | 재시작 |

### 진단 토픽

```yaml
# /diagnostics
status:
  - level: 0  # OK=0, WARN=1, ERROR=2
    name: "jetrover: STM32"
    message: "Communication OK"
    hardware_id: "stm32_bridge"
    values:
      - key: "last_heartbeat"
        value: "10ms"
      - key: "packet_loss"
        value: "0%"
```

---

*JetRover AI Architecture v3.0 | Jetson Orin Nano 8GB + ROS2 Humble + 6DOF Mecanum*
